<!doctype html>
<html lang=RU>
  <head>
    <title>Маршрут до заказа</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.css">
    <style>

    </style>
    <!-- <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script> -->
<!--     <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&mode=release"></script> -->
    <script src="/stat/lib/jquery_2.2.3_min.js?v1"></script>

    <script src="/static/jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <!-- Google Tag Manager -->
    {{#if general.production}}
    <noscript>
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-PHD7WW" height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PHD7WW');</script>
    {{/if}}
    <!-- End Google Tag Manager -->
  </head>
  <body class="">
    <div data-role="page" class="jqm-demos ui-responsive-panel" id="mainPage" data-title="Заявки на средства и материалы">
      <div data-role="header" data-position="fixed" data-tap-toggle="false">
        <h1 style="overflow: visible">Маршрут до заказа</h1>
        <a href="#nav-panel" data-icon="bars" data-iconpos="notext">Menu</a>
      </div>
      <div role="main" class="ui-content jqm-content jqm-fullwidth">
        <script>$(document).unbind('scroll');</script>
        <p style=margin-top:100px;text-align:center>Загрузка карты...</p>

      <div data-role="panel" data-display="overlay" data-theme="b" id="nav-panel">
        <ul data-role="listview">
          <li data-icon="delete"><a href="#" data-rel="close">Закрыть Меню</a></li>
          <li><a data-ajax="false" href="{{staffUrl 'employeeDetail' selfId }}?profile=true">Профиль</a></li>
          <li><a href="{{staffUrl 'creditsCurrent' selfId }}">Заработано</a></li>
          <li><a href="{{staffUrl 'depositCurrent' selfId }}">Необходимо сдать</a></li>
          <li><a href="{{staffUrl 'employeeDetail' selfId }}?orders=true" class='ui-btn ui-btn-active'>Заказы</a></li>
          <li><a data-ajax="false" href="{{staffUrl 'rating' selfId }}">Рейтинг</a></li>
          <li><a href="{{staffUrl 'disciplinaryList' selfId }}">Нарушения</a></li>
          <li><a href="{{staffUrl 'conversationList' selfId }}">Обращения</a></li>
          <li><a href="{{staffUrl 'news' selfId}}">Новости</a></li>
          <li><a data-ajax=false href="{{staffUrl 'means_and_materials' selfId}}">Средства и материалы</a></li>
          <li><a data-ajax=false href="{{staffUrl 'description_services' selfId}}">Услуги</a></li>
          <!-- <li><a data-ajax="false" onclick="mobile_view(false)" href="">Полная версия</a></li> -->
          <li><a data-ajax="false" href="{{staffUrl 'logout' }}">Выйти</a></li>
        </ul>
      </div>
      </div>
    </div>

    <!-- yandex map route to order -->
    <div id=map style="width:100%;height:100%;padding:0;margin:0"></div>

    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&mode=release"></script>
    <script>

    void function () {
      var address_order = {{{adress_order}}};
      address_order[0] = parseFloat(address_order[0]);
      address_order[1] = parseFloat(address_order[1]);
      // TODO: В opera mobile дико долго грузится...
      build_route_from_current_position_to('map', address_order);
    }();

    function build_route_from_current_position_to(id, adress_order) {
      ymaps.ready(function() {
        ymaps.geolocation.get().then(function(res) {
          var current_position = res.geoObjects.position;

          ini_maps(myMap, { from: current_position, to: adress_order });

          // FOR TEST
          // |
          // V
          // От кординат офиса яндекс не строит маршруты
          // ini_maps(id, { from: [55.830384, 37.633812], to: adress_order });
        }, function(e) {
          console.error(e);
        });
      });

      /**
       * ini_maps
       * @param  {String} id    'main' // id where build map
       * @param  {Object} options {
       *  from: [55.6329202, 37.5367192], // широта долгота
       *  to: [55.6329202, 37.5367192]
       * }
       */
      function ini_maps(id, options) {
        console.log(id, options.from, options.to);
        var myMap = new ymaps.Map(id, {
          //       широта, долгота
          center: [55.753994, 37.622093], // moscow
          zoom: 9,
          // Добавим панель маршрутизации.
          controls: ['routePanelControl']
        });

        var control = myMap.controls.get('routePanelControl');

        // Зададим состояние панели для построения машрутов.
        control.routePanel.state.set({
          // Тип маршрутизации.
          type: 'masstransit',
          // Выключим возможность задавать пункт отправления в поле ввода.
          fromEnabled: false,
          // Адрес или координаты пункта отправления.
          // from: 'Москва, Льва Толстого 16',
          from: options.from,
          // Включим возможность задавать пункт назначения в поле ввода.
          toEnabled: true,
            // Адрес или координаты пункта назначения.
            // to: 'Петербург'
          // to: 'Москва, Льва Толстого 2',
          to: options.to
        });

        // Зададим опции панели для построения машрутов.
        control.routePanel.options.set({
          // Запрещаем показ кнопки, позволяющей менять местами начальную и конечную точки маршрута.
          allowSwitch: false,
          // Включим определение адреса по координатам клика.
          // Адрес будет автоматически подставляться в поле ввода на панели, а также в подпись метки маршрута.
          reverseGeocoding: true,
          // Зададим виды маршрутизации, которые будут доступны пользователям для выбора.
          types: {
            masstransit: true,
            pedestrian: true
          }
        });

        // Создаем кнопку, с помощью которой пользователи смогут менять местами начальную и конечную точки маршрута.
        var switchPointsButton = new ymaps.control.Button({
          data: {
            content: "Поменять местами",
            title: "Поменять точки местами"
          },
          options: {
            selectOnClick: false,
            maxWidth: 160
          }
        });
        // Объявляем обработчик для кнопки.
        switchPointsButton.events.add('click', function() {
          // Меняет местами начальную и конечную точки маршрута.
          control.routePanel.switchPoints();
        });
        myMap.controls.add(switchPointsButton);
      }
    }


    </script>
  </body>
</html>