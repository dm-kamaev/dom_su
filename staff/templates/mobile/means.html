<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.css">
    <style>
      .digit{
        font-weight: bold
      }
    </style>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src="/static/jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.js"></script>
    {{!-- <script src="/static/js/custom_cookie.js?v=1.0"></script> --}}
    <!-- For autocomplete -->
    <!-- <script src="https://code.jquery.com/jquery-1.12.4.js"></script> -->
    <!-- <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script> -->
    <!-- <script src="/stat/lib/jquery-ui.js?v3"></script> -->
    <!-- Google Tag Manager -->
    {{#if general.production}}
    <noscript>
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-PHD7WW" height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PHD7WW');</script>
    {{/if}}
    <!-- End Google Tag Manager -->
  </head>
  <body class="">
    <div data-role="page" class="jqm-demos ui-responsive-panel" id="mainPage" data-title="Личный кабинет от Домовёнка">
      <div data-role="header" data-position="fixed" data-tap-toggle="false">
        <h1 style="overflow: visible">Заявки на средства и материалы</h1>
        <a href="#nav-panel" data-icon="bars" data-iconpos="notext">Menu</a>
      </div>
      <div role="main" class="ui-content jqm-content jqm-fullwidth">
        <script>$(document).unbind('scroll');</script>

        <a data-ajax=false href='/staff/{{selfId}}/history_about_means_materials'>История получения средств и материалов</a>

        <p>Лимит на средства и материалы: <span class=digit>{{getEmployeeData.MatLimit}}</span> руб.</p>

        <div data-role="tabs" id="tabs">

          <div data-role="navbar">
            <ul>
              <li><a href="#means" class="ui-btn-active">Средства</a></li>
              <li><a href="#materials">Материалы</a></li>
            </ul>
          </div>

          <div id=means class="ui-body-d ui-content">
            {{#each means as |mean| }}
            <div style=margin-top:30px>
              {{!-- TODO: photo --}}
              <label>
                <input type=checkbox name="checkbox-0" data-key={{mean.data_key}} data-my-type=check>Выбрать
              </label>
              <p>inventory_title = {{mean.inventory_title}}</p>
              <p>inventory_description = {{mean.inventory_description}}</p>
              <p>price = {{mean.price}} руб.</p>
              <div>
                <div style=width:36% class="ui-field-contain">
                  <select name="select-native-2" id="select-native-2" data-mini="true" data-key={{mean.data_key}} data-my-type=quantity>
                    {{#each mean.quantity as |quan| }}
                    <option value={{quan}}>{{quan}} {{mean.package_title}}</option>
                    {{/each}}
                  </select>
                </div>
              </div>
            </div>
            {{/each}}
          </div>

          <div id=materials>
            {{#each materials as |material| }}
            <div style=margin-top:30px>
              {{!-- TODO: photo --}}
              <label>
                <input type=checkbox name="checkbox-0" data-key={{material.data_key}} data-my-type=check>Выбрать
              </label>
              <p>inventory_title = {{material.inventory_title}}</p>
              <p>inventory_description = {{material.inventory_description}}</p>
              <p>price = {{material.price}} руб.</p>
              <div>
                <div style=width:36% class="ui-field-contain">
                  <select name="select-native-2" id="select-native-2" data-mini="true" data-key={{material.data_key}} data-my-type=quantity>
                    {{#each material.quantity as |quan| }}
                    <option value={{quan}}>{{quan}} {{material.package_title}}</option>
                    {{/each}}
                  </select>
                </div>
              </div>
            </div>
            {{/each}}
          </div>

        </div>

        <div style="margin-top:16px;border-top:2px solid #999;font-size:120%">
          <p>Итог по средствам: <span id=total_means class=digit></span> руб.</p>
          <p>Итог по материалам: <span id=total_materials class=digit></span> руб.</p>
          <p>Итог всего: <span id=total class=digit></span> руб.</p>
          <p id=status_text style=font-size:100%></p>
          <button id=create_proposal type=button>Оформить заявку</button>
          <p style=color:red id=error></p>
        </div>
      </div>
      <div data-role="panel" data-display="overlay" data-theme="b" id="nav-panel">
        <ul data-role="listview">
          <li data-icon="delete"><a href="#" data-rel="close">Закрыть Меню</a></li>
          <li><a data-ajax="false" href="{{staffUrl 'employeeDetail' selfId }}?profile=true" class="ui-btn ui-btn-active">Профиль</a></li>
          <li><a href="{{staffUrl 'creditsCurrent' selfId }}">Заработано</a></li>
          <li><a href="{{staffUrl 'depositCurrent' selfId }}">Необходимо сдать</a></li>
          <li><a href="{{staffUrl 'employeeDetail' selfId }}?orders=true">Заказы</a></li>
          <li><a data-ajax="false" href="{{staffUrl 'rating' selfId }}">Рейтинг</a></li>
          <li><a href="{{staffUrl 'disciplinaryList' selfId }}">Нарушения</a></li>
          <li><a href="{{staffUrl 'conversationList' selfId }}">Обращения</a></li>
          <li><a href="{{staffUrl 'news' selfId}}">Новости</a></li>
          <li><a data-ajax="false" onclick="mobile_view(false)" href="">Полная версия</a></li>
          <li><a data-ajax="false" href="{{staffUrl 'logout' }}">Выйти</a></li>
        </ul>
      </div>
    </div>
    <script>
    void function () {
      function getById(id) { return document.getElementById(id); }
      function getTarget(e) { return e && e.target || e.srcElement; }
      function getDataAttribute(el) {
        el = (typeof el === 'string') ? getByID(el) : el;
        return el.dataset || {};
      }
      function objectKeys(obj) {
        var keys = [];
        for (var key in obj) {
          if (obj.hasOwnProperty(key)) { keys.push(key); }
        }
        return keys;
      }
      if (!Object.keys) {
        Object.keys = objectKeys;
      }

      new Api({{{getEmployeeData.MatLimit}}}, {{{hash_mean_material}}}).set_events('tabs');

      function Api(_mat_limit, _hash_mean_material) {
        var _active_hash = {};
        var $create_proposal = getById('create_proposal');
        _mat_limit = to_cents(_mat_limit);

        update_total_means(0);
        update_total_materials(0);
        update_total(0);
        update_status_text(_mat_limit);

        this.set_events = function (id) {
          getById(id).onchange = onchange;
          $create_proposal.onclick = create_proposal;
        };

        function onchange(e) {
          var t = getTarget(e);
          var data = getDataAttribute(t);
          var type = data.myType;
          var key = data.key;
          var el;
          // console.log('BEFORE Change', t, data, t.value);
          if (type === 'check') {
            var checked = t.checked;
            console.log('Change check', t, t.checked);
            el = _hash_mean_material[key];
            el.checked = checked;
            if (checked) {
              _active_hash[key] = el;
            } else {
              delete _active_hash[key];
            }
            recalc();
            console.dir(_active_hash);
          } else if (type === 'quantity') {
            var value = t.value;
            el = _hash_mean_material[key];
            el.quantity = parseInt(value, 10);
            if (el.checked) {
              _active_hash[key] = el;
              recalc();
            }
            console.log('Change quantity', t, );
            console.dir(_active_hash);
          }
        }

        function create_proposal(e) {
          $create_proposal.style.opacity = .5;
          var keys = Object.keys(_active_hash)
          if (!Object.keys(_active_hash).length) {
            return getById('error').innerHTML = '* Выберите средства или материалы';
          }
          var data = [];
          for (var i = 0, l = keys.length; i < l; i++) {
            var el = _active_hash[keys[i]];
            data.push({
              InventoryID: el.inventory_id,
              PackageID: el.package_id,
              Quantity: 1
            });
          }
          console.log('SEND AJAX =', data);
      }

        function recalc() {
          var keys = Object.keys(_active_hash);
          var total_means = 0;
          var total_materials = 0;
          for (var i = 0, l = keys.length; i < l; i++) {
            var el = _active_hash[keys[i]];
            var res = el.quantity * to_cents(el.price);
            var type = el.type;
            if (type === 'mean') {
              total_means += res;
            } else if (type === 'material') {
              total_materials += res;
            } else {
              console.error('Incorrect type =>'+type);
            }
          }
          var total = total_means + total_materials;
          update_total_means(total_means);
          update_total_materials(total_materials);
          update_total(total);
          update_status_text(_mat_limit - total);
        }

        function update_total_means(means) {
          getById('total_means').innerHTML = to_rubles(means);
        }

        function update_total_materials(materials) {
          getById('total_materials').innerHTML = to_rubles(materials);
        }

        function update_total(total) {
          getById('total').innerHTML = to_rubles(total);
        }

        function update_status_text(new_mat_limit) {
          var text = '';
          var $status_text = getById('status_text');
          if (new_mat_limit < 0) {
            $status_text.innerHTML = 'Вам не хватает '+to_rubles((-1 * new_mat_limit))+' руб. , уберите что-нибудь или уменьшите количество';
            $status_text.style.color = 'red';
          } else {
            $status_text.innerHTML = 'У вас оcталось еще '+ to_rubles(new_mat_limit)+' руб.';
            $status_text.style.color = 'green';
          }
        }

        function to_cents(digit) {
          return digit * 100;
        }

        function to_rubles(digit) {
          return (digit / 100).toFixed(2);
        }

      }

    }();
    </script>
  </body>
</html>